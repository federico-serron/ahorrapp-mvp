<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <!-- Seguridad: CSP Header en servidor -->
    <title>ðŸ’° Expense Tracker Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container { max-width: 1000px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 40px; margin-top: 20px; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .card {
            background: white; border-radius: 15px; padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); margin-bottom: 20px;
        }
        .hidden { display: none; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        input, select { 
            width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;
            font-size: 1em; transition: border-color 0.3s;
        }
        input:focus, select:focus { outline: none; border-color: #667eea; }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; padding: 12px 30px; border-radius: 8px;
            font-size: 1em; font-weight: 600; cursor: pointer;
            transition: transform 0.2s; width: 100%;
        }
        button:hover { transform: translateY(-2px); }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        .message {
            padding: 15px; border-radius: 8px; margin-top: 15px; display: none;
        }
        .message.show { display: block; }
        .success { background: #4caf50; color: white; }
        .error { background: #f44336; color: white; }
        .transaction-item {
            background: #f5f5f5; padding: 15px; border-radius: 8px;
            margin-bottom: 10px; border-left: 4px solid #667eea;
            display: flex; justify-content: space-between; align-items: center;
        }
        .transaction-item.income { border-left-color: #4caf50; }
        .transaction-item.expense { border-left-color: #f44336; }
        .stat-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px; margin-bottom: 30px;
        }
        .stat-card {
            background: #f5f5f5; padding: 20px; border-radius: 8px; text-align: center;
        }
        .stat-value { font-size: 2em; font-weight: bold; color: #667eea; }
        .stat-label { color: #666; margin-top: 10px; font-size: 0.9em; }
        .stat-card.income .stat-value { color: #4caf50; }
        .stat-card.expense .stat-value { color: #f44336; }
        .charts-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        .chart-container { position: relative; height: 300px; }
        h2 { margin-bottom: 20px; color: #333; }
        .logout-btn {
            background: #f44336; width: auto; display: inline-block;
            padding: 8px 20px; float: right;
        }
        .auth-form { max-width: 400px; margin: 0 auto; }
        .tab-buttons { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 10px; background: #ccc; border: none; cursor: pointer; border-radius: 8px; }
        .tab-btn.active { background: #667eea; color: white; }
        .transactions-list { max-height: 500px; overflow-y: auto; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;
        }
        .modal.show { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; }
        .btn-small {
            background: #667eea; color: white; border: none; padding: 6px 12px;
            border-radius: 4px; cursor: pointer; font-size: 0.85em;
        }
        .btn-danger {
            background: #f44336; color: white; border: none; padding: 6px 12px;
            border-radius: 4px; cursor: pointer; font-size: 0.85em; margin-left: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login/Register -->
        <div id="authSection">
            <div class="header">
                <h1>ðŸ’° Expense Tracker Pro</h1>
            </div>

            <div class="card auth-form">
                <div class="tab-buttons">
                    <button class="tab-btn active" onclick="switchTab(event, 'login')">Login</button>
                    <button class="tab-btn" onclick="switchTab(event, 'register')">Registro</button>
                </div>

                <form id="loginForm">
                    <h2>Inicia SesiÃ³n</h2>
                    <div class="form-group">
                        <label>Usuario</label>
                        <input type="text" id="loginUsername" required minlength="3" maxlength="20">
                    </div>
                    <div class="form-group">
                        <label>ContraseÃ±a</label>
                        <input type="password" id="loginPassword" required minlength="4" maxlength="128">
                    </div>
                    <button type="submit">Login</button>
                    <div class="message" id="loginMessage"></div>
                </form>

                <form id="registerForm" class="hidden">
                    <h2>Crear Cuenta</h2>
                    <div class="form-group">
                        <label>Usuario</label>
                        <input type="text" id="regUsername" required minlength="3" maxlength="20" pattern="[a-zA-Z0-9_-]+">
                    </div>
                    <div class="form-group">
                        <label>ContraseÃ±a</label>
                        <input type="password" id="regPassword" required minlength="4" maxlength="128">
                    </div>
                    <button type="submit">Registrarse</button>
                    <div class="message" id="registerMessage"></div>
                </form>
            </div>
        </div>

        <!-- Main App -->
        <div id="appSection" class="hidden">
            <div class="header">
                <h1>ðŸ’° Expense Tracker Pro</h1>
                <p id="userName" style="margin-top: 10px;"></p>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>

            <div class="stat-grid">
                <div class="stat-card income">
                    <div class="stat-value" id="incomeTotal">$0.00</div>
                    <div class="stat-label">Ingresos</div>
                </div>
                <div class="stat-card expense">
                    <div class="stat-value" id="expenseTotal">$0.00</div>
                    <div class="stat-label">Gastos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="balanceTotal">$0.00</div>
                    <div class="stat-label">Balance</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="card">
                    <h3>Gastos por CategorÃ­a</h3>
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h3>Ingresos vs Gastos</h3>
                    <div class="chart-container">
                        <canvas id="incomeExpenseChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Nueva TransacciÃ³n</h2>
                <form id="transactionForm">
                    <div class="form-group">
                        <label>DescripciÃ³n</label>
                        <input type="text" id="description" placeholder="Ej: Sueldo o Cine" required maxlength="500">
                    </div>
                    <div class="form-group">
                        <label>Monto</label>
                        <input type="number" id="amount" placeholder="100.00" step="0.01" required>
                    </div>
                    <button type="submit">Registrar</button>
                    <div class="message" id="message"></div>
                </form>
            </div>

            <div class="card">
                <h2>Historial</h2>
                <div class="transactions-list" id="transactionsList">
                    <p style="color: #999; text-align: center; padding: 20px;">Cargando...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h2>Editar TransacciÃ³n</h2>
            <form id="editForm">
                <div class="form-group">
                    <label>DescripciÃ³n</label>
                    <input type="text" id="editDescription" required maxlength="500">
                </div>
                <div class="form-group">
                    <label>Monto</label>
                    <input type="number" id="editAmount" step="0.01" required>
                </div>
                <button type="submit">Guardar</button>
                <button type="button" class="btn-danger" onclick="deleteAndClose()">Eliminar</button>
            </form>
        </div>
    </div>

    <script>
        // ================================================================
        // CONFIGURACIÃ“N Y ESTADO
        // ================================================================
        const API_URL = 'http://localhost:5001';
        const State = {
            currentUser: null,
            transactions: [],
            editingTransactionId: null,
            charts: { category: null, incomeExpense: null }
        };

        // ================================================================
        // SANITIZACIÃ“N XSS
        // ================================================================
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // ================================================================
        // VALIDACIÃ“N DE INPUTS
        // ================================================================
        function validateUsername(username) {
            if (!username || username.length < 3 || username.length > 20) {
                throw new Error('Username: 3-20 caracteres');
            }
            if (!/^[a-zA-Z0-9_-]+$/.test(username)) {
                throw new Error('Solo letras, nÃºmeros, guiones');
            }
            return username;
        }

        function validatePassword(password) {
            if (!password || password.length < 4) {
                throw new Error('Password: mÃ­n 4 caracteres');
            }
            return password;
        }

        function validateDescription(desc) {
            if (!desc || desc.length > 500) {
                throw new Error('DescripciÃ³n: mÃ¡x 500 caracteres');
            }
            return desc;
        }

        function validateAmount(amount) {
            const num = parseFloat(amount);
            if (isNaN(num) || num === 0) {
                throw new Error('Monto: nÃºmero vÃ¡lido');
            }
            if (Math.abs(num) > 1000000) {
                throw new Error('Monto: demasiado grande');
            }
            return num;
        }

        // ================================================================
        // AUTENTICACIÃ“N
        // ================================================================
        document.getElementById('loginForm').addEventListener('submit', handleLogin);
        document.getElementById('registerForm').addEventListener('submit', handleRegister);

        async function handleLogin(e) {
            e.preventDefault();
            const msgDiv = document.getElementById('loginMessage');
            try {
                const username = validateUsername(document.getElementById('loginUsername').value);
                const password = validatePassword(document.getElementById('loginPassword').value);

                const response = await fetch(`${API_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();
                if (response.ok) {
                    State.currentUser = data;
                    showApp();
                    fetchTransactions();
                    fetchStats();
                } else {
                    showMessage(msgDiv, data.error || 'Error', 'error');
                }
            } catch (e) {
                showMessage(msgDiv, e.message, 'error');
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const msgDiv = document.getElementById('registerMessage');
            try {
                const username = validateUsername(document.getElementById('regUsername').value);
                const password = validatePassword(document.getElementById('regPassword').value);

                const response = await fetch(`${API_URL}/api/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();
                if (response.ok) {
                    showMessage(msgDiv, 'Usuario creado! Inicia sesiÃ³n', 'success');
                    setTimeout(() => switchTab({target: document.querySelector('[onclick*="login"]')}, 'login'), 1500);
                } else {
                    showMessage(msgDiv, data.error || 'Error', 'error');
                }
            } catch (e) {
                showMessage(msgDiv, e.message, 'error');
            }
        }

        // ================================================================
        // TRANSACCIONES
        // ================================================================
        document.getElementById('transactionForm').addEventListener('submit', handleAddTransaction);

        async function handleAddTransaction(e) {
            e.preventDefault();
            const msgDiv = document.getElementById('message');
            try {
                const description = validateDescription(document.getElementById('description').value);
                const amount = validateAmount(document.getElementById('amount').value);

                const response = await fetch(`${API_URL}/api/transactions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: State.currentUser.id,
                        description,
                        amount
                    })
                });

                if (response.ok) {
                    showMessage(msgDiv, 'âœ… Registrado!', 'success');
                    document.getElementById('transactionForm').reset();
                    fetchTransactions();
                    fetchStats();
                    setTimeout(() => msgDiv.classList.remove('show'), 2000);
                } else {
                    const data = await response.json();
                    showMessage(msgDiv, data.error || 'Error', 'error');
                }
            } catch (e) {
                showMessage(msgDiv, e.message, 'error');
            }
        }

        async function fetchTransactions() {
            try {
                const response = await fetch(`${API_URL}/api/transactions?user_id=${State.currentUser.id}`);
                State.transactions = await response.json();
                renderTransactions();
            } catch (e) {
                console.error('Error:', e);
            }
        }

        async function fetchStats() {
            try {
                const response = await fetch(`${API_URL}/api/stats?user_id=${State.currentUser.id}`);
                const stats = await response.json();

                document.getElementById('incomeTotal').textContent = `$${stats.total_income.toFixed(2)}`;
                document.getElementById('expenseTotal').textContent = `$${stats.total_expenses.toFixed(2)}`;
                document.getElementById('balanceTotal').textContent = `$${stats.balance.toFixed(2)}`;

                updateCharts(stats);
            } catch (e) {
                console.error('Error:', e);
            }
        }

        function renderTransactions() {
            if (State.transactions.length === 0) {
                document.getElementById('transactionsList').innerHTML = '<p style="color: #999;">Sin transacciones</p>';
                return;
            }

            document.getElementById('transactionsList').innerHTML = State.transactions.map(t => `
                <div class="transaction-item ${t.type}">
                    <div>
                        <strong>${escapeHtml(t.description)}</strong>
                        <div style="font-size: 0.85em; color: #666; margin-top: 5px;">
                            ${escapeHtml(t.category)}
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <div style="color: ${t.type === 'income' ? '#4caf50' : '#f44336'}; font-weight: bold;">
                            ${t.type === 'income' ? '+' : '-'}$${Math.abs(t.amount).toFixed(2)}
                        </div>
                        <button class="btn-small" onclick="openEditModal(${t.id}, '${escapeHtml(t.description)}', ${t.amount})">Editar</button>
                    </div>
                </div>
            `).join('');
        }

        document.getElementById('editForm').addEventListener('submit', handleEditTransaction);

        async function handleEditTransaction(e) {
            e.preventDefault();
            try {
                const description = validateDescription(document.getElementById('editDescription').value);
                const amount = validateAmount(document.getElementById('editAmount').value);

                const response = await fetch(`${API_URL}/api/transactions/${State.editingTransactionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: State.currentUser.id,
                        description,
                        amount
                    })
                });

                if (response.ok) {
                    closeModal();
                    fetchTransactions();
                    fetchStats();
                }
            } catch (e) {
                console.error('Error:', e);
            }
        }

        async function deleteAndClose() {
            if (!confirm('Â¿Eliminar?')) return;

            try {
                const response = await fetch(`${API_URL}/api/transactions/${State.editingTransactionId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: State.currentUser.id })
                });

                if (response.ok) {
                    closeModal();
                    fetchTransactions();
                    fetchStats();
                }
            } catch (e) {
                console.error('Error:', e);
            }
        }

        // ================================================================
        // UI
        // ================================================================
        function switchTab(event, tab) {
            document.getElementById('loginForm').classList.toggle('hidden', tab !== 'login');
            document.getElementById('registerForm').classList.toggle('hidden', tab !== 'register');

            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function showApp() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('appSection').classList.remove('hidden');
            document.getElementById('userName').textContent = `Bienvenido, ${escapeHtml(State.currentUser.username)}! ðŸ‘‹`;
        }

        function logout() {
            State.currentUser = null;
            State.transactions = [];
            document.getElementById('appSection').classList.add('hidden');
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('loginForm').reset();
            document.getElementById('registerForm').reset();
        }

        function openEditModal(id, description, amount) {
            State.editingTransactionId = id;
            document.getElementById('editDescription').value = description;
            document.getElementById('editAmount').value = amount;
            document.getElementById('editModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('editModal').classList.remove('show');
            State.editingTransactionId = null;
        }

        function showMessage(div, text, type) {
            div.textContent = text;
            div.className = `message show ${type}`;
        }

        function updateCharts(stats) {
            const labels = stats.by_category.map(c => c.category);
            const data = stats.by_category.map(c => c.total);

            if (State.charts.category) State.charts.category.destroy();
            const ctxCategory = document.getElementById('categoryChart').getContext('2d');
            State.charts.category = new Chart(ctxCategory, {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{
                        data,
                        backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#00f2fe', '#4caf50', '#ff9800', '#f44336']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            if (State.charts.incomeExpense) State.charts.incomeExpense.destroy();
            const ctxIncome = document.getElementById('incomeExpenseChart').getContext('2d');
            State.charts.incomeExpense = new Chart(ctxIncome, {
                type: 'bar',
                data: {
                    labels: ['Ingresos', 'Gastos'],
                    datasets: [{
                        label: '$',
                        data: [stats.total_income, stats.total_expenses],
                        backgroundColor: ['#4caf50', '#f44336']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }
    </script>
</body>
</html>
